<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Better Boyfriend (Real AI)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js" crossorigin="anonymous"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #000; overflow: hidden; touch-action: none; }
        
        /* Glassmorphism UI */
        .glass {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.15);
        }

        /* The Ghost Guide (Target Pose) */
        #targetOverlay {
            transition: all 0.3s ease;
            opacity: 0.5;
        }
        .matched {
            stroke: #00FF00 !important;
            stroke-width: 4px !important;
            filter: drop-shadow(0 0 10px #00FF00);
            opacity: 1 !important;
        }

        /* Loading Spinner */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #00FFFF;
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
    </style>
</head>

<body class="h-screen w-screen relative text-white">

    <video id="webcam" class="absolute inset-0 w-full h-full object-cover z-0 transform scale-x-[-1]" autoplay playsinline muted></video>
    
    <canvas id="output_canvas"></canvas>

    <div class="absolute inset-0 flex items-center justify-center z-15 pointer-events-none">
        <svg id="targetOverlay" class="w-full h-full max-w-md max-h-[80vh] transition-all duration-300"
            viewBox="0 0 300 600" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            </svg>
    </div>

    <div class="absolute inset-0 z-30 flex flex-col justify-between pointer-events-none">
        
        <div class="w-full p-6 pt-12 flex justify-between items-start">
            <div id="statusBadge" class="bg-black/40 px-3 py-1 rounded-full backdrop-blur-md border border-white/10 flex items-center gap-2">
                <div id="aiSpinner" class="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></div>
                <span id="statusText" class="text-[10px] font-bold uppercase tracking-[0.2em] text-white">Loading Model...</span>
            </div>
        </div>

        <div class="absolute top-1/4 w-full text-center px-4">
            <h1 id="instruction" class="text-3xl font-black italic uppercase tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500 drop-shadow-lg transition-all duration-200">
                Wait...
            </h1>
            <p id="subtext" class="text-sm font-mono text-cyan-200 mt-2 tracking-widest uppercase opacity-80">Initializing Vision Engine</p>
        </div>

        <div class="w-full glass pb-10 pt-6 rounded-t-[2.5rem] pointer-events-auto shadow-2xl">
            <div class="flex overflow-x-auto px-6 gap-4 mb-8 no-scrollbar justify-center">
                <button onclick="setPose('tourist')" class="pose-btn px-4 py-2 rounded-full border border-white/20 bg-white/5 text-[10px] font-bold uppercase tracking-wider transition-all">
                    Tourist (Raise Hand)
                </button>
                <button onclick="setPose('power')" class="pose-btn px-4 py-2 rounded-full border border-white/20 bg-white/5 text-[10px] font-bold uppercase tracking-wider transition-all">
                    Power Pose (Hands on Hips)
                </button>
            </div>

            <div class="flex justify-center items-center">
                <button class="w-20 h-20 rounded-full border-4 border-white/80 flex items-center justify-center active:scale-95 transition-transform shadow-lg bg-white/10">
                    <div class="w-16 h-16 bg-white rounded-full"></div>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { PoseLandmarker, FilesetResolver, DrawingUtils } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js";

        // --- CONFIG ---
        const video = document.getElementById("webcam");
        const canvasElement = document.getElementById("output_canvas");
        const canvasCtx = canvasElement.getContext("2d");
        const instruction = document.getElementById("instruction");
        const subtext = document.getElementById("subtext");
        const targetOverlay = document.getElementById("targetOverlay");
        const statusText = document.getElementById("statusText");
        const aiSpinner = document.getElementById("aiSpinner");

        let poseLandmarker = undefined;
        let webcamRunning = false;
        let currentPose = 'tourist'; // Default

        // --- POSE DEFINITIONS (The "Ghost" Templates) ---
        const poses = {
            'tourist': {
                name: "The Tourist",
                svg: `
                    <circle cx="150" cy="100" r="30" stroke="white" stroke-dasharray="5 5"/>
                    <line x1="150" y1="130" x2="150" y2="300" stroke="white" stroke-dasharray="5 5"/>
                    <polyline points="150,150 220,100 240,50" stroke="white" stroke-width="2" stroke-dasharray="5 5" />
                    <polyline points="150,150 80,200 60,280" stroke="white" stroke-dasharray="5 5" />
                    <text x="150" y="500" fill="white" font-size="12" text-anchor="middle" font-family="monospace">RAISE RIGHT HAND</text>
                `,
                check: (landmarks) => {
                    // Logic: Is Right Wrist (16) HIGHER (y is smaller) than Right Eye (5)?
                    const rightWrist = landmarks[16];
                    const rightEye = landmarks[5];
                    if(!rightWrist || !rightEye) return "Body Not Visible";
                    
                    if (rightWrist.y < rightEye.y) return true; // Hand is raised high
                    return false;
                },
                hint: "Raise right hand high!"
            },
            'power': {
                name: "Power Pose",
                svg: `
                    <circle cx="150" cy="100" r="30" stroke="white" stroke-dasharray="5 5"/>
                    <line x1="150" y1="130" x2="150" y2="300" stroke="white" stroke-dasharray="5 5"/>
                    <polyline points="150,150 100,200 120,280" stroke="white" stroke-dasharray="5 5"/> 
                    <polyline points="150,150 200,200 180,280" stroke="white" stroke-dasharray="5 5"/>
                    <text x="150" y="500" fill="white" font-size="12" text-anchor="middle" font-family="monospace">HANDS ON HIPS</text>
                `,
                check: (landmarks) => {
                    // Logic: Are wrists (15,16) near hips (23,24)?
                    // Simplified: Just check if wrists are below shoulders but above knees
                    const lw = landmarks[15]; const rw = landmarks[16];
                    const ls = landmarks[11]; const rs = landmarks[12];
                    
                    if(!lw || !rw) return "Body Not Visible";
                    // Check if wrists are below shoulders (y > shoulder.y)
                    if (lw.y > ls.y && rw.y > rs.y) return true;
                    return false;
                },
                hint: "Put hands on hips!"
            }
        };

        // --- 1. INITIALIZE AI MODEL ---
        async function createPoseLandmarker() {
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
            
            poseLandmarker = await PoseLandmarker.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: `https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task`,
                    delegate: "GPU"
                },
                runningMode: "VIDEO",
                numPoses: 1
            });
            
            statusText.innerText = "AI ONLINE";
            aiSpinner.classList.remove("bg-yellow-400");
            aiSpinner.classList.add("bg-green-400");
            enableCam();
        }

        // --- 2. WEBCAM SETUP ---
        function enableCam() {
            if (!poseLandmarker) { console.log("Wait for model to load"); return; }
            webcamRunning = true;

            const constraints = { video: { facingMode: "user", width: 1280, height: 720 } };

            navigator.mediaDevices.getUserMedia(constraints).then((stream) => {
                video.srcObject = stream;
                video.addEventListener("loadeddata", predictWebcam);
            });
        }

        // --- 3. THE LOOP (30 FPS) ---
        let lastVideoTime = -1;
        
        async function predictWebcam() {
            canvasElement.width = video.videoWidth;
            canvasElement.height = video.videoHeight;
            let startTimeMs = performance.now();

            if (lastVideoTime !== video.currentTime) {
                lastVideoTime = video.currentTime;
                
                // RUN AI INFERENCE
                poseLandmarker.detectForVideo(video, startTimeMs, (result) => {
                    canvasCtx.save();
                    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                    
                    // IF BODY DETECTED
                    if (result.landmarks.length > 0) {
                        const landmarks = result.landmarks[0];
                        
                        // A. Draw Skeleton (The "Vision" Effect)
                        const drawingUtils = new DrawingUtils(canvasCtx);
                        drawingUtils.drawConnectors(landmarks, PoseLandmarker.POSE_CONNECTIONS, { color: "#00FFFF", lineWidth: 2 });
                        drawingUtils.drawLandmarks(landmarks, { color: "#FFFFFF", lineWidth: 1, radius: 3 });

                        // B. Check The Pose Logic
                        checkPose(landmarks);
                    } else {
                        instruction.innerText = "NO HUMAN";
                        instruction.className = "text-3xl font-black italic uppercase text-gray-500";
                    }
                    canvasCtx.restore();
                });
            }

            if (webcamRunning) window.requestAnimationFrame(predictWebcam);
        }

        // --- 4. THE LOGIC (MATH) ---
        function checkPose(landmarks) {
            const activePose = poses[currentPose];
            const isMatch = activePose.check(landmarks);

            if (isMatch === true) {
                // SUCCESS STATE
                instruction.innerText = "PERFECT!";
                instruction.className = "text-5xl font-black italic uppercase text-green-400 drop-shadow-[0_0_15px_rgba(0,255,0,0.8)] scale-110 transition-transform";
                subtext.innerText = "HOLD IT RIGHT THERE";
                
                targetOverlay.classList.add("matched");
                targetOverlay.style.stroke = "#00FF00";
            } else {
                // GUIDANCE STATE
                instruction.innerText = "ADJUST...";
                instruction.className = "text-3xl font-black italic uppercase text-white";
                subtext.innerText = activePose.hint;
                
                targetOverlay.classList.remove("matched");
                targetOverlay.style.stroke = "white";
            }
        }

        // --- UI HANDLERS ---
        window.setPose = (key) => {
            currentPose = key;
            targetOverlay.innerHTML = poses[key].svg;
        }

        // Start
        createPoseLandmarker();
        setPose('tourist');

    </script>
</body>
</html>
